#!/bin/bash
# TLP Profile Manager - Gerenciador de Perfis de Energia
# Autor: Claude Code
# Uso: tlp-perfil [balanceado|economia|performance|status]

set -e

# Cores para output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color
BOLD='\033[1m'

# Diret√≥rio dos perfis
TLP_DIR="/etc/tlp.d"
BALANCEADO_FILE="$TLP_DIR/90-perfil-balanceado.conf"
ECONOMIA_FILE="$TLP_DIR/90-perfil-economia.conf"
PERFORMANCE_FILE="$TLP_DIR/90-perfil-performance.conf"

# Fun√ß√£o para detectar perfil ativo
get_current_profile() {
    if [ -f "$ECONOMIA_FILE" ]; then
        echo "economia"
    elif [ -f "$PERFORMANCE_FILE" ]; then
        echo "performance"
    elif [ -f "$BALANCEADO_FILE" ]; then
        echo "balanceado"
    else
        echo "desconhecido"
    fi
}

# Fun√ß√£o para mostrar status
show_status() {
    local current=$(get_current_profile)

    echo -e "${BOLD}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
    echo -e "${BOLD}           STATUS DO TLP - GERENCIAMENTO DE ENERGIA${NC}"
    echo -e "${BOLD}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
    echo ""

    case $current in
        "balanceado")
            echo -e "${BOLD}Perfil Ativo:${NC} ${GREEN}‚óè${NC} BALANCEADO"
            echo -e "${CYAN}Ganho:${NC} ~25-30% bateria extra"
            echo -e "${CYAN}Impacto:${NC} Quase impercept√≠vel"
            ;;
        "economia")
            echo -e "${BOLD}Perfil Ativo:${NC} ${BLUE}‚óè${NC} M√ÅXIMA ECONOMIA"
            echo -e "${CYAN}Ganho:${NC} ~50-60% bateria extra"
            echo -e "${CYAN}Impacto:${NC} Sistema visivelmente mais lento"
            ;;
        "performance")
            echo -e "${BOLD}Perfil Ativo:${NC} ${RED}‚óè${NC} PERFORMANCE M√ÅXIMA"
            echo -e "${CYAN}Ganho:${NC} 0% (bateria dura menos)"
            echo -e "${CYAN}Impacto:${NC} Performance m√°xima"
            ;;
    esac

    echo ""
    echo -e "${BOLD}Configura√ß√µes Atuais (Bateria):${NC}"

    # L√™ configura√ß√µes do sistema
    local cpu_epp=$(cat /sys/devices/system/cpu/cpu0/cpufreq/energy_performance_preference 2>/dev/null || echo "N/A")
    local cpu_boost=$(cat /sys/devices/system/cpu/intel_pstate/no_turbo 2>/dev/null || echo "N/A")
    if [ "$cpu_boost" = "0" ]; then
        cpu_boost="ON"
    elif [ "$cpu_boost" = "1" ]; then
        cpu_boost="OFF"
    fi

    local gpu_max=$(cat /sys/class/drm/card*/gt_max_freq_mhz 2>/dev/null | head -1 || echo "N/A")

    echo -e "  ${BOLD}CPU EPP:${NC} $cpu_epp"
    echo -e "  ${BOLD}CPU Turbo:${NC} $cpu_boost"
    echo -e "  ${BOLD}GPU Max:${NC} ${gpu_max} MHz"

    echo ""
    echo -e "${BOLD}Perfis Dispon√≠veis:${NC}"
    echo "  tlp-perfil balanceado   - Economia moderada (recomendado)"
    echo "  tlp-perfil economia     - M√°xima economia (viagens)"
    echo "  tlp-perfil performance  - Performance total (ignora economia)"
    echo ""
}

# Fun√ß√£o para mostrar compara√ß√£o
show_comparison() {
    local from=$1
    local to=$2

    # Define valores dos perfis
    declare -A PROFILES
    PROFILES=(
        ["balanceado_epp"]="balance_power"
        ["balanceado_max"]="100%"
        ["balanceado_gpu"]="1000 MHz"
        ["balanceado_turbo"]="OFF"

        ["economia_epp"]="power"
        ["economia_max"]="60%"
        ["economia_gpu"]="700 MHz"
        ["economia_turbo"]="OFF"

        ["performance_epp"]="balance_performance"
        ["performance_max"]="100%"
        ["performance_gpu"]="1400 MHz"
        ["performance_turbo"]="ON"
    )

    echo ""
    echo -e "${BOLD}üìä Configura√ß√µes Alteradas:${NC}"
    echo "‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê"
    printf "‚îÇ ${BOLD}%-21s${NC} ‚îÇ ${YELLOW}%-20s${NC} ‚îÇ ${GREEN}%-20s${NC} ‚îÇ\n" "Configura√ß√£o" "Antes ($from)" "Depois ($to)"
    echo "‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§"
    printf "‚îÇ %-21s ‚îÇ %-20s ‚îÇ %-20s ‚îÇ\n" "CPU EPP (BAT)" "${PROFILES[${from}_epp]}" "${PROFILES[${to}_epp]}"
    printf "‚îÇ %-21s ‚îÇ %-20s ‚îÇ %-20s ‚îÇ\n" "CPU Max (BAT)" "${PROFILES[${from}_max]}" "${PROFILES[${to}_max]}"
    printf "‚îÇ %-21s ‚îÇ %-20s ‚îÇ %-20s ‚îÇ\n" "GPU Max (BAT)" "${PROFILES[${from}_gpu]}" "${PROFILES[${to}_gpu]}"
    printf "‚îÇ %-21s ‚îÇ %-20s ‚îÇ %-20s ‚îÇ\n" "CPU Turbo (BAT)" "${PROFILES[${from}_turbo]}" "${PROFILES[${to}_turbo]}"
    echo "‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò"
    echo ""
}

# Fun√ß√£o para ativar perfil
activate_profile() {
    local profile=$1
    local current=$(get_current_profile)

    # Se j√° est√° no perfil solicitado
    if [ "$current" = "$profile" ]; then
        echo -e "${YELLOW}‚ö†${NC}  Perfil ${BOLD}${profile}${NC} j√° est√° ativo."
        return 0
    fi

    echo -e "${CYAN}üîÑ Trocando perfil:${NC} ${current} ‚Üí ${BOLD}${profile}${NC}"

    # Mostra compara√ß√£o
    show_comparison "$current" "$profile"

    # Desativa todos os perfis
    sudo mv "$BALANCEADO_FILE" "${BALANCEADO_FILE}.disabled" 2>/dev/null || true
    sudo mv "$ECONOMIA_FILE" "${ECONOMIA_FILE}.disabled" 2>/dev/null || true
    sudo mv "$PERFORMANCE_FILE" "${PERFORMANCE_FILE}.disabled" 2>/dev/null || true

    # Ativa o perfil solicitado
    case $profile in
        "balanceado")
            if [ -f "${BALANCEADO_FILE}.disabled" ]; then
                sudo mv "${BALANCEADO_FILE}.disabled" "$BALANCEADO_FILE"
            else
                echo -e "${RED}‚úó${NC} Arquivo ${BALANCEADO_FILE}.disabled n√£o encontrado!"
                return 1
            fi
            ;;
        "economia")
            if [ -f "${ECONOMIA_FILE}.disabled" ]; then
                sudo mv "${ECONOMIA_FILE}.disabled" "$ECONOMIA_FILE"
            else
                echo -e "${RED}‚úó${NC} Arquivo ${ECONOMIA_FILE}.disabled n√£o encontrado!"
                return 1
            fi
            ;;
        "performance")
            if [ -f "${PERFORMANCE_FILE}.disabled" ]; then
                sudo mv "${PERFORMANCE_FILE}.disabled" "$PERFORMANCE_FILE"
            else
                echo -e "${RED}‚úó${NC} Arquivo ${PERFORMANCE_FILE}.disabled n√£o encontrado!"
                return 1
            fi
            ;;
        *)
            echo -e "${RED}‚úó${NC} Perfil desconhecido: $profile"
            return 1
            ;;
    esac

    # Aplica as configura√ß√µes
    echo -e "${CYAN}‚öô${NC}  Aplicando configura√ß√µes..."
    if sudo tlp start >/dev/null 2>&1; then
        echo -e "${GREEN}‚úì${NC}  Perfil ${BOLD}${profile}${NC} aplicado com sucesso!"
        echo ""
        echo -e "${BOLD}As mudan√ßas foram aplicadas imediatamente.${NC}"
        echo "N√£o √© necess√°rio reiniciar o sistema."
    else
        echo -e "${RED}‚úó${NC} Erro ao aplicar configura√ß√µes TLP."
        return 1
    fi
}

# Fun√ß√£o de ajuda
show_help() {
    echo "Uso: tlp-perfil [op√ß√£o]"
    echo ""
    echo "Op√ß√µes:"
    echo "  balanceado    - Ativa perfil balanceado (padr√£o, ~25-30% economia)"
    echo "  economia      - Ativa perfil de m√°xima economia (~50-60% economia)"
    echo "  performance   - Ativa perfil de performance m√°xima (0% economia)"
    echo "  status        - Mostra perfil ativo e configura√ß√µes atuais"
    echo "  help          - Mostra esta ajuda"
    echo ""
}

# Main
case "${1:-status}" in
    "balanceado"|"balanced")
        activate_profile "balanceado"
        ;;
    "economia"|"economy"|"powersave")
        activate_profile "economia"
        ;;
    "performance"|"perf")
        activate_profile "performance"
        ;;
    "status"|"s")
        show_status
        ;;
    "help"|"-h"|"--help")
        show_help
        ;;
    *)
        echo -e "${RED}‚úó${NC} Op√ß√£o inv√°lida: $1"
        echo ""
        show_help
        exit 1
        ;;
esac
